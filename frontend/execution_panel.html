<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoderLang Execution Engine</title>

    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <!-- CheerpJ (Java) -->
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0e1117;
            color: #ffffff;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #controls {
            padding: 10px;
            background-color: #262730;
            border-bottom: 1px solid #444;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background-color: #00d26a;
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #00b359;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #tabs {
            display: flex;
            background-color: #1e1e1e;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            background-color: #1e1e1e;
            border-right: 1px solid #333;
            color: #888;
        }

        .tab.active {
            background-color: #0e1117;
            color: white;
            border-top: 2px solid #00d26a;
        }

        #content-area {
            position: relative;
            height: 400px;
            /* Fixed height for iframe context */
            width: 100%;
        }

        .view {
            display: none;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #ffffff;
            color: black;
        }

        .view.active {
            display: block;
        }

        #log-container {
            background-color: #000;
            color: #0f0;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 10px;
            height: 100%;
            box-sizing: border-box;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 14px;
        }

        #canvas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            color: black;
        }

        #dom-container {
            background-color: white;
            color: black;
            padding: 10px;
            overflow: auto;
        }

        /* Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #00d26a;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="controls">
        <button id="run-btn" onclick="runCode()">▶ Run Code</button>
        <div class="spinner" id="loader"></div>
        <span id="status-text" style="font-size: 12px; color: #aaa;">Ready</span>
    </div>

    <div id="tabs">
        <div class="tab active" onclick="switchTab('logs')">Logs</div>
        <div class="tab" onclick="switchTab('canvas')">Canvas / UI</div>
        <div class="tab" onclick="switchTab('dom')">DOM Output</div>
    </div>

    <div id="content-area">
        <div id="log-container" class="view active"></div>
        <div id="canvas-container" class="view">
            <canvas id="main-canvas"></canvas>
        </div>
        <div id="dom-container" class="view"></div>
    </div>

    <script>
        // --- STATE ---
        let pyodide = null;

        // --- INJECTED VARIABLES ---
        const CODE = `__CODE_GOES_HERE__`;
        const LANGUAGE = `__LANG_GOES_HERE__`;

        // --- SETUP ---
        window.onload = async function () {
            log(`Welcome to CoderLang Execution Engine`);
            log(`Detected Language: ${LANGUAGE}`);

            if (LANGUAGE === 'python') {
                document.getElementById('status-text').innerText = "Loading Pyodide...";
                document.getElementById('loader').style.display = 'block';
                document.getElementById('run-btn').disabled = true;

                try {
                    pyodide = await loadPyodide();
                    await pyodide.loadPackage(["micropip", "matplotlib", "numpy", "pandas"]);

                    document.getElementById('status-text').innerText = "Pyodide Ready";
                    document.getElementById('run-btn').disabled = false;
                } catch (e) {
                    log(`Failed to load Pyodide: ${e}`, 'error');
                } finally {
                    document.getElementById('loader').style.display = 'none';
                }
            } else if (LANGUAGE === 'java') {
                document.getElementById('status-text').innerText = "Ready (CheerpJ)";
            } else {
                document.getElementById('status-text').innerText = "Ready (JS/Native)";
            }
        };

        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.textContent = message;
            if (type === 'error') {
                entry.style.color = '#ff5555';
            } else if (type === 'warn') {
                entry.style.color = '#ffb86c';
            }
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'logs') {
                document.getElementById('log-container').classList.add('active');
            } else if (tabName === 'canvas') {
                document.getElementById('canvas-container').classList.add('active');
            } else {
                document.getElementById('dom-container').classList.add('active');
            }
        }

        // --- RUNNERS ---
        async function runCode() {
            clearLogs();
            document.getElementById('loader').style.display = 'block';

            try {
                if (LANGUAGE === 'python') {
                    await runPython();
                } else if (LANGUAGE === 'javascript') {
                    runJS();
                } else if (LANGUAGE === 'java') {
                    await runJava();
                } else {
                    log(`Execution for ${LANGUAGE} is not yet implemented.`, 'warn');
                }
            } catch (e) {
                log(`Error: ${e.message || e}`, 'error');
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        async function runJava() {
            log(">>> Executing Java code...");
            log("Initializing CheerpJ...");
            try {
                await cheerpjInit();
                log("CheerpJ Ready.");
                log("⚠️ Java Source execution requires client-side compilation.", 'warn');
                log("Feature coming soon: On-the-fly javac compilation.");

            } catch (e) {
                log(`CheerpJ Error: ${e}`, 'error');
            }
        }

        async function runPython() {
            log(">>> Executing Python code...");
            if (!pyodide) {
                log("Pyodide not loaded yet.", 'error');
                return;
            }

            // Redirect stdout
            pyodide.setStdout({ batched: (msg) => log(msg) });
            pyodide.setStderr({ batched: (msg) => log(msg, 'error') });

            // Setup Canvas for Matplotlib
            const canvasDiv = document.getElementById('canvas-container');
            canvasDiv.innerHTML = '<div id="plot-target"></div>';
            document.pyodideMplTarget = document.getElementById('plot-target');

            // Wrap code to target canvas if using matplotlib
            const wrappedCode = `
import sys
import os
from js import document

# Mocking standard plot show to target our div if needed, 
# but Pyodide's matplotlib backend usually handles 'figure' element creation.
# We just ensure the environment is clean.

${CODE}
            `;

            await pyodide.runPythonAsync(wrappedCode);
            log(">>> Execution Complete");

            // Check if we should switch to canvas tab (heuristic)
            if (CODE.includes('matplotlib') || CODE.includes('plt.show')) {
                switchTab('canvas');
            }
        }

        function runJS() {
            log(">>> Executing JavaScript code...");
            // For JS, we use a safe-ish eval or Function
            // We redirect console.log
            const originalLog = console.log;
            const originalError = console.error;

            console.log = (...args) => log(args.join(' '));
            console.error = (...args) => log(args.join(' '), 'error');

            const domContainer = document.getElementById('dom-container');
            domContainer.innerHTML = ''; // Clear previous

            try {
                const sandboxCode = `
                    const print = (...args) => console.log(...args);
                    const container = document.getElementById('dom-container');
                    const canvas = document.getElementById('main-canvas'); // Expose the main canvas
                    
                    ${CODE}
                `;

                new Function(sandboxCode)();

                log(">>> JS Execution Triggered");

                if (CODE.includes('document.') || CODE.includes('canvas')) {
                    switchTab('canvas'); // or dom
                }

            } catch (e) {
                console.error(e);
            } finally {
                // Restore console (optional, but good practice if we were sharing window)
                // console.log = originalLog;
            }
        }

    </script>
</body>

</html>